ECSSecurityGroup:
  Type: AWS::EC2::SecurityGroup
  Properties:
    GroupDescription: >
      Security Group do ECS (Metabase).
      Recebe trÃ¡fego SOMENTE do ALB na porta 3000
      e acessa apenas serviÃ§os necessÃ¡rios.
    VpcId: !Ref VpcId

    # ðŸ”½ ENTRADA â€” somente ALB â†’ ECS
    SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 3000
        ToPort: 3000
        SourceSecurityGroupId: !Ref ALBSecurityGroup
        Description: >
          Permite trÃ¡fego do ALB para o Metabase
          exclusivamente na porta 3000

    # ðŸ”¼ SAÃDA â€” somente o necessÃ¡rio
    SecurityGroupEgress:

      # Postgres (RDS)
      - IpProtocol: tcp
        FromPort: 5432
        ToPort: 5432
        DestinationSecurityGroupId: !Ref RDSSecurityGroup
        Description: >
          Permite conexÃ£o com o RDS PostgreSQL (5432)

      # HTTPS â€” AWS APIs (Secrets Manager, CloudWatch, etc)
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
        Description: >
          Permite acesso HTTPS para AWS APIs
          (Secrets Manager, Logs, etc)

    Tags:
      - Key: Project
        Value: Metabase
      - Key: Component
        Value: ECS
      - Key: Environment
        Value: prod


Outputs:

  ECSSecurityGroupId:
    Description: Security Group do ECS Metabase
    Value: !Ref ECSSecurityGroup
    Export:
      Name: Metabase-EcsSecurityGroup

  ECSSecurityGroupArn:
    Description: ARN do Security Group do ECS
    Value: !GetAtt ECSSecurityGroup.GroupId